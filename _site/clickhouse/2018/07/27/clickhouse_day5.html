<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>clickhouse day 5 (clickhouse Distributed table)</title>
  <meta name="description" content="docker-compose.yaml">

  <link rel="stylesheet" href="/assets/main.css">
  <link rel="canonical" href="http://localhost:4000/clickhouse/2018/07/27/clickhouse_day5.html">
  <link rel="alternate" type="application/rss+xml" title="Daniel&#39;s Blog" href="/feed.xml">
  
  
</head>


  <body>

    <header class="site-header" role="banner">

  <div class="wrapper">
    
    
    <a class="site-title" href="/">Daniel&#39;s Blog</a>
  
    
      <nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
              <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
              <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger">
          
            
            
          
            
            
            <a class="page-link" href="/about/">About</a>
            
          
            
            
          
            
            
          
            
            
          
        </div>
      </nav>
    
  </div>
</header>


    <main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">clickhouse day 5 (clickhouse Distributed table)</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2018-07-27T10:44:17+08:00" itemprop="datePublished">
        
        Jul 27, 2018
      </time>
      </p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <h4 id="docker-composeyaml">docker-compose.yaml</h4>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>version: "3.2"
services:
  ch-server-1:
    image: yandex/clickhouse-server
    volumes:
      - ./config.xml:/etc/clickhouse-server/config.xml
      - ./include_from.xml:/etc/clickhouse-server/include_from.xml
      - ./macros1.xml:/etc/clickhouse-server/macros.xml
      - ./hosts:/etc/hosts
    ports:
      - 8123:8123
  ch-server-2:
    image: yandex/clickhouse-server
    volumes:
      - ./config.xml:/etc/clickhouse-server/config.xml
      - ./include_from.xml:/etc/clickhouse-server/include_from.xml
      - ./macros2.xml:/etc/clickhouse-server/macros.xml
      - ./hosts:/etc/hosts
  ch-server-3:
    image: yandex/clickhouse-server
    volumes:
      - ./config.xml:/etc/clickhouse-server/config.xml
      - ./macros3.xml:/etc/clickhouse-server/macros.xml
      - ./hosts:/etc/hosts
      - ./include_from.xml:/etc/clickhouse-server/include_from.xml
  ch-client:
    image: yandex/clickhouse-client
    entrypoint:
      - /bin/sleep
    command:
      - infinity
    volumes:
      - ./hosts:/etc/hosts
  zookeeper:
    image: zookeeper
    volumes:
      - ./hosts:/etc/hosts

</code></pre></div></div>

<h4 id="clickhouse-的-configxml-設定">clickhouse 的 config.xml 設定</h4>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?xml version="1.0"?&gt;</span>
<span class="nt">&lt;yandex&gt;</span>
    <span class="nt">&lt;logger&gt;</span>
        <span class="nt">&lt;level&gt;</span>trace<span class="nt">&lt;/level&gt;</span>
        <span class="nt">&lt;log&gt;</span>/var/log/clickhouse-server/clickhouse-server.log<span class="nt">&lt;/log&gt;</span>
        <span class="nt">&lt;errorlog&gt;</span>/var/log/clickhouse-server/clickhouse-server.err.log<span class="nt">&lt;/errorlog&gt;</span>
        <span class="nt">&lt;size&gt;</span>1000M<span class="nt">&lt;/size&gt;</span>
        <span class="nt">&lt;count&gt;</span>10<span class="nt">&lt;/count&gt;</span>
    <span class="nt">&lt;/logger&gt;</span>


    <span class="nt">&lt;http_port&gt;</span>8123<span class="nt">&lt;/http_port&gt;</span>

    <span class="c">&lt;!--
    &lt;https_port&gt;8443&lt;/https_port&gt;
    --&gt;</span>
    <span class="c">&lt;!-- Used only with https_port. Full ssl options list: https://github.com/yandex/ClickHouse/blob/master/contrib/libpoco/NetSSL_OpenSSL/include/Poco/Net/SSLManager.h#L71 --&gt;</span>
    <span class="nt">&lt;openSSL&gt;</span>
        <span class="nt">&lt;server&gt;</span>
            <span class="c">&lt;!-- openssl req -subj "/CN=localhost" -new -newkey rsa:2048 -days 365 -nodes -x509 -keyout /etc/clickhouse-server/server.key -out /etc/clickhouse-server/server.crt --&gt;</span>
            <span class="nt">&lt;certificateFile&gt;</span>/etc/clickhouse-server/server.crt<span class="nt">&lt;/certificateFile&gt;</span>
            <span class="nt">&lt;privateKeyFile&gt;</span>/etc/clickhouse-server/server.key<span class="nt">&lt;/privateKeyFile&gt;</span>
            <span class="c">&lt;!-- openssl dhparam -out /etc/clickhouse-server/dhparam.pem 4096 --&gt;</span>
            <span class="nt">&lt;dhParamsFile&gt;</span>/etc/clickhouse-server/dhparam.pem<span class="nt">&lt;/dhParamsFile&gt;</span>
            <span class="nt">&lt;verificationMode&gt;</span>none<span class="nt">&lt;/verificationMode&gt;</span>
            <span class="nt">&lt;loadDefaultCAFile&gt;</span>true<span class="nt">&lt;/loadDefaultCAFile&gt;</span>
            <span class="nt">&lt;cacheSessions&gt;</span>true<span class="nt">&lt;/cacheSessions&gt;</span>
            <span class="nt">&lt;disableProtocols&gt;</span>sslv2,sslv3<span class="nt">&lt;/disableProtocols&gt;</span>
            <span class="nt">&lt;preferServerCiphers&gt;</span>true<span class="nt">&lt;/preferServerCiphers&gt;</span>
        <span class="nt">&lt;/server&gt;</span>
        <span class="nt">&lt;client&gt;</span>
            <span class="nt">&lt;loadDefaultCAFile&gt;</span>true<span class="nt">&lt;/loadDefaultCAFile&gt;</span>
            <span class="nt">&lt;cacheSessions&gt;</span>true<span class="nt">&lt;/cacheSessions&gt;</span>
            <span class="nt">&lt;disableProtocols&gt;</span>sslv2,sslv3<span class="nt">&lt;/disableProtocols&gt;</span>
            <span class="nt">&lt;preferServerCiphers&gt;</span>true<span class="nt">&lt;/preferServerCiphers&gt;</span>
            <span class="c">&lt;!-- Use for self-signed: &lt;verificationMode&gt;none&lt;/verificationMode&gt; --&gt;</span>
            <span class="nt">&lt;invalidCertificateHandler&gt;</span>
                <span class="c">&lt;!-- Use for self-signed: &lt;name&gt;AcceptCertificateHandler&lt;/name&gt; --&gt;</span>
                <span class="nt">&lt;name&gt;</span>RejectCertificateHandler<span class="nt">&lt;/name&gt;</span>
            <span class="nt">&lt;/invalidCertificateHandler&gt;</span>
        <span class="nt">&lt;/client&gt;</span>
    <span class="nt">&lt;/openSSL&gt;</span>

    <span class="c">&lt;!-- Default root page on http[s] server. For example load UI from https://tabix.io/ when opening http://localhost:8123 --&gt;</span>
    <span class="c">&lt;!--
    &lt;http_server_default_response&gt;&lt;![CDATA[&lt;html ng-app="SMI2"&gt;&lt;head&gt;&lt;base href="http://ui.tabix.io/"&gt;&lt;/head&gt;&lt;body&gt;&lt;div ui-view="" class="content-ui"&gt;&lt;/div&gt;&lt;script src="http://loader.tabix.io/master.js"&gt;&lt;/script&gt;&lt;/body&gt;&lt;/html&gt;]]&gt;&lt;/http_server_default_response&gt;
    --&gt;</span>

    <span class="nt">&lt;tcp_port&gt;</span>9000<span class="nt">&lt;/tcp_port&gt;</span>

    <span class="c">&lt;!-- Port for communication between replicas. Used for data exchange. --&gt;</span>
    <span class="nt">&lt;interserver_http_port&gt;</span>9009<span class="nt">&lt;/interserver_http_port&gt;</span>

    <span class="c">&lt;!-- Hostname that is used by other replicas to request this server.
         If not specified, than it is determined analoguous to 'hostname -f' command.
         This setting could be used to switch replication to another network interface.
      --&gt;</span>
    <span class="c">&lt;!--
    &lt;interserver_http_host&gt;example.yandex.ru&lt;/interserver_http_host&gt;
    --&gt;</span>
    <span class="nt">&lt;networks</span> <span class="na">incl=</span><span class="s">"networks"</span> <span class="na">replace=</span><span class="s">"replace"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;ip&gt;</span>::/0<span class="nt">&lt;/ip&gt;</span>
    <span class="nt">&lt;/networks&gt;</span>

    <span class="c">&lt;!-- Listen specified host. use :: (wildcard IPv6 address), if you want to accept connections both with IPv4 and IPv6 from everywhere. --&gt;</span>
    <span class="nt">&lt;listen_host&gt;</span>::<span class="nt">&lt;/listen_host&gt;</span>
    <span class="c">&lt;!-- &lt;listen_host&gt;::1&lt;/listen_host&gt; --&gt;</span>
    <span class="c">&lt;!-- &lt;listen_host&gt;0.0.0.0&lt;/listen_host&gt; --&gt;</span>

    <span class="nt">&lt;max_connections&gt;</span>4096<span class="nt">&lt;/max_connections&gt;</span>
    <span class="nt">&lt;keep_alive_timeout&gt;</span>3<span class="nt">&lt;/keep_alive_timeout&gt;</span>

    <span class="c">&lt;!-- Maximum number of concurrent queries. --&gt;</span>
    <span class="nt">&lt;max_concurrent_queries&gt;</span>100<span class="nt">&lt;/max_concurrent_queries&gt;</span>

    <span class="c">&lt;!-- Set limit on number of open files (default: maximum). This setting makes sense on Mac OS X because getrlimit() fails to retrieve
         correct maximum value. --&gt;</span>
    <span class="c">&lt;!-- &lt;max_open_files&gt;262144&lt;/max_open_files&gt; --&gt;</span>

    <span class="c">&lt;!-- Size of cache of uncompressed blocks of data, used in tables of MergeTree family.
         In bytes. Cache is single for server. Memory is allocated only on demand.
         Cache is used when 'use_uncompressed_cache' user setting turned on (off by default).
         Uncompressed cache is advantageous only for very short queries and in rare cases.
      --&gt;</span>
    <span class="nt">&lt;uncompressed_cache_size&gt;</span>8589934592<span class="nt">&lt;/uncompressed_cache_size&gt;</span>

    <span class="c">&lt;!-- Approximate size of mark cache, used in tables of MergeTree family.
         In bytes. Cache is single for server. Memory is allocated only on demand.
         You should not lower this value.
      --&gt;</span>
    <span class="nt">&lt;mark_cache_size&gt;</span>5368709120<span class="nt">&lt;/mark_cache_size&gt;</span>


    <span class="c">&lt;!-- Path to data directory, with trailing slash. --&gt;</span>
    <span class="nt">&lt;path&gt;</span>/var/lib/clickhouse/<span class="nt">&lt;/path&gt;</span>

    <span class="c">&lt;!-- Path to temporary data for processing hard queries. --&gt;</span>
    <span class="nt">&lt;tmp_path&gt;</span>/var/lib/clickhouse/tmp/<span class="nt">&lt;/tmp_path&gt;</span>

    <span class="c">&lt;!-- Path to configuration file with users, access rights, profiles of settings, quotas. --&gt;</span>
    <span class="nt">&lt;users_config&gt;</span>users.xml<span class="nt">&lt;/users_config&gt;</span>

    <span class="c">&lt;!-- Default profile of settings.. --&gt;</span>
    <span class="nt">&lt;default_profile&gt;</span>default<span class="nt">&lt;/default_profile&gt;</span>

    <span class="c">&lt;!-- Default database. --&gt;</span>
    <span class="nt">&lt;default_database&gt;</span>default<span class="nt">&lt;/default_database&gt;</span>

    <span class="c">&lt;!-- Server time zone could be set here.
         Time zone is used when converting between String and DateTime types,
          when printing DateTime in text formats and parsing DateTime from text,
          it is used in date and time related functions, if specific time zone was not passed as an argument.
         Time zone is specified as identifier from IANA time zone database, like UTC or Africa/Abidjan.
         If not specified, system time zone at server startup is used.
         Please note, that server could display time zone alias instead of specified name.
         Example: W-SU is an alias for Europe/Moscow and Zulu is an alias for UTC.
    --&gt;</span>
    <span class="c">&lt;!-- &lt;timezone&gt;Europe/Moscow&lt;/timezone&gt; --&gt;</span>

    <span class="c">&lt;!-- You can specify umask here (see "man umask"). Server will apply it on startup.
         Number is always parsed as octal. Default umask is 027 (other users cannot read logs, data files, etc; group can only read).
    --&gt;</span>
    <span class="c">&lt;!-- &lt;umask&gt;022&lt;/umask&gt; --&gt;</span>

    <span class="c">&lt;!-- Configuration of clusters that could be used in Distributed tables.
         https://clickhouse.yandex/reference_en.html#Distributed
      --&gt;</span>
    <span class="nt">&lt;include_from&gt;</span>/etc/clickhouse-server/include_from.xml<span class="nt">&lt;/include_from&gt;</span>
    <span class="nt">&lt;remote_servers</span> <span class="na">incl=</span><span class="s">"clickhouse_remote_servers"</span> <span class="nt">/&gt;</span>

    <span class="c">&lt;!-- If element has 'incl' attribute, then for it's value will be used corresponding substitution from another file.
         By default, path to file with substitutions is /etc/metrika.xml. It could be changed in config in 'include_from' element.
         Values for substitutions are specified in /yandex/name_of_substitution elements in that file.
      --&gt;</span>

    <span class="c">&lt;!-- ZooKeeper is used to store metadata about replicas, when using Replicated tables.
         Optional. If you don't use replicated tables, you could omit that.
         See https://clickhouse.yandex/reference_en.html#Data%20replication
      --&gt;</span>
    <span class="nt">&lt;zookeeper</span> <span class="na">incl=</span><span class="s">"zookeeper-servers"</span> <span class="na">optional=</span><span class="s">"true"</span> <span class="nt">/&gt;</span>
    <span class="c">&lt;!-- Substitutions for parameters of replicated tables.
          Optional. If you don't use replicated tables, you could omit that.
         See https://clickhouse.yandex/reference_en.html#Creating%20replicated%20tables
      --&gt;</span>
    <span class="c">&lt;!-- &lt;macros incl="macros" optional="true" /&gt; --&gt;</span>
    <span class="nt">&lt;macros&gt;</span>
        <span class="nt">&lt;shard&gt;</span>01<span class="nt">&lt;/shard&gt;</span>
        <span class="nt">&lt;replica&gt;</span>ch1<span class="nt">&lt;/replica&gt;</span>
    <span class="nt">&lt;/macros&gt;</span>


    <span class="c">&lt;!-- Reloading interval for embedded dictionaries, in seconds. Default: 3600. --&gt;</span>
    <span class="nt">&lt;builtin_dictionaries_reload_interval&gt;</span>3600<span class="nt">&lt;/builtin_dictionaries_reload_interval&gt;</span>


    <span class="c">&lt;!-- Maximum session timeout, in seconds. Default: 3600. --&gt;</span>
    <span class="nt">&lt;max_session_timeout&gt;</span>3600<span class="nt">&lt;/max_session_timeout&gt;</span>

    <span class="c">&lt;!-- Default session timeout, in seconds. Default: 60. --&gt;</span>
    <span class="nt">&lt;default_session_timeout&gt;</span>60<span class="nt">&lt;/default_session_timeout&gt;</span>

    <span class="c">&lt;!-- Sending data to Graphite for monitoring. Several sections can be defined. --&gt;</span>
    <span class="c">&lt;!--
        interval - send every X second
        root_path - prefix for keys
        metrics - send data from table system.metrics
        events - send data from table system.events
        asynchronous_metrics - send data from table system.asynchronous_metrics
    --&gt;</span>
    <span class="c">&lt;!--
    &lt;graphite&gt;
        &lt;host&gt;localhost&lt;/host&gt;
        &lt;port&gt;42000&lt;/port&gt;
        &lt;timeout&gt;0.1&lt;/timeout&gt;
        &lt;interval&gt;60&lt;/interval&gt;
        &lt;root_path&gt;one_min&lt;/root_path&gt;
        &lt;metrics&gt;true&lt;/metrics&gt;
        &lt;events&gt;true&lt;/events&gt;
        &lt;asynchronous_metrics&gt;true&lt;/asynchronous_metrics&gt;
    &lt;/graphite&gt;
    &lt;graphite&gt;
        &lt;host&gt;localhost&lt;/host&gt;
        &lt;port&gt;42000&lt;/port&gt;
        &lt;timeout&gt;0.1&lt;/timeout&gt;
        &lt;interval&gt;1&lt;/interval&gt;
        &lt;root_path&gt;one_sec&lt;/root_path&gt;
        &lt;metrics&gt;true&lt;/metrics&gt;
        &lt;events&gt;true&lt;/events&gt;
        &lt;asynchronous_metrics&gt;false&lt;/asynchronous_metrics&gt;
    &lt;/graphite&gt;
    --&gt;</span>


    <span class="c">&lt;!-- Query log. Used only for queries with setting log_queries = 1. --&gt;</span>
    <span class="nt">&lt;query_log&gt;</span>
        <span class="c">&lt;!-- What table to insert data. If table is not exist, it will be created.
             When query log structure is changed after system update,
              then old table will be renamed and new table will be created automatically.
        --&gt;</span>
        <span class="nt">&lt;database&gt;</span>system<span class="nt">&lt;/database&gt;</span>
        <span class="nt">&lt;table&gt;</span>query_log<span class="nt">&lt;/table&gt;</span>

        <span class="c">&lt;!-- Interval of flushing data. --&gt;</span>
        <span class="nt">&lt;flush_interval_milliseconds&gt;</span>7500<span class="nt">&lt;/flush_interval_milliseconds&gt;</span>
    <span class="nt">&lt;/query_log&gt;</span>


    <span class="c">&lt;!-- Uncomment if use part_log
    &lt;part_log&gt;
        &lt;database&gt;system&lt;/database&gt;
        &lt;table&gt;part_log&lt;/table&gt;
        &lt;flush_interval_milliseconds&gt;7500&lt;/flush_interval_milliseconds&gt;
    &lt;/part_log&gt;
    --&gt;</span>


    <span class="c">&lt;!-- Parameters for embedded dictionaries, used in Yandex.Metrica.
         See https://clickhouse.yandex/reference_en.html#Internal%20dictionaries
    --&gt;</span>

    <span class="c">&lt;!-- Path to file with region hierarchy. --&gt;</span>
    <span class="c">&lt;!-- &lt;path_to_regions_hierarchy_file&gt;/opt/geo/regions_hierarchy.txt&lt;/path_to_regions_hierarchy_file&gt; --&gt;</span>

    <span class="c">&lt;!-- Path to directory with files containing names of regions --&gt;</span>
    <span class="c">&lt;!-- &lt;path_to_regions_names_files&gt;/opt/geo/&lt;/path_to_regions_names_files&gt; --&gt;</span>


    <span class="c">&lt;!-- Configuration of external dictionaries. See:
         https://clickhouse.yandex/reference_en.html#External%20Dictionaries
    --&gt;</span>
    <span class="nt">&lt;dictionaries_config&gt;</span>*_dictionary.xml<span class="nt">&lt;/dictionaries_config&gt;</span>

    <span class="c">&lt;!-- Uncomment if you want data to be compressed 30-100% better.
         Don't do that if you just started using ClickHouse.
      --&gt;</span>

    <span class="nt">&lt;compression</span> <span class="na">incl=</span><span class="s">"clickhouse_compression"</span><span class="nt">&gt;</span>
    <span class="c">&lt;!--
        &lt;!- - Set of variants. Checked in order. Last matching case wins. If nothing matches, lz4 will be used. - -&gt;
        &lt;case&gt;
            &lt;!- - Conditions. All must be satisfied. Some conditions may be omitted. - -&gt;
            &lt;min_part_size&gt;10000000000&lt;/min_part_size&gt;        &lt;!- - Min part size in bytes. - -&gt;
            &lt;min_part_size_ratio&gt;0.01&lt;/min_part_size_ratio&gt;    &lt;!- - Min size of part relative to whole table size. - -&gt;
            &lt;!- - What compression method to use. - -&gt;
            &lt;method&gt;zstd&lt;/method&gt;    &lt;!- - Keep in mind that zstd compression library is highly experimental. - -&gt;
        &lt;/case&gt;
    --&gt;</span>
    <span class="nt">&lt;/compression&gt;</span>

    <span class="nt">&lt;resharding&gt;</span>
        <span class="nt">&lt;task_queue_path&gt;</span>/clickhouse/task_queue<span class="nt">&lt;/task_queue_path&gt;</span>
    <span class="nt">&lt;/resharding&gt;</span>

    <span class="c">&lt;!-- Allow to execute distributed DDL queries (CREATE, DROP, ALTER, RENAME) on cluster.
         Works only if ZooKeeper is enabled. Comment it if such functionality isn't required. --&gt;</span>
    <span class="nt">&lt;distributed_ddl&gt;</span>
        <span class="c">&lt;!-- Path in ZooKeeper to queue with DDL queries --&gt;</span>
        <span class="nt">&lt;path&gt;</span>/clickhouse/task_queue/ddl<span class="nt">&lt;/path&gt;</span>
    <span class="nt">&lt;/distributed_ddl&gt;</span>

    <span class="c">&lt;!-- Settings to fine tune MergeTree tables. See documentation in source code, in MergeTreeSettings.h --&gt;</span>
    <span class="c">&lt;!--
    &lt;merge_tree&gt;
        &lt;max_suspicious_broken_parts&gt;5&lt;/max_suspicious_broken_parts&gt;
    &lt;/merge_tree&gt;
    --&gt;</span>

    <span class="c">&lt;!-- Protection from accidental DROP.
         If size of a MergeTree table is greater than max_table_size_to_drop (in bytes) than table could not be dropped with any DROP query.
         If you want do delete one table and don't want to restart clickhouse-server, you could create special file &lt;clickhouse-path&gt;/flags/force_drop_table and make DROP once.
         By default max_table_size_to_drop is 50GB, max_table_size_to_drop=0 allows to DROP any tables.
         Uncomment to disable protection.
    --&gt;</span>
    <span class="c">&lt;!-- &lt;max_table_size_to_drop&gt;0&lt;/max_table_size_to_drop&gt; --&gt;</span>

    <span class="c">&lt;!-- Example of parameters for GraphiteMergeTree table engine --&gt;</span>
    <span class="nt">&lt;graphite_rollup_example&gt;</span>
        <span class="nt">&lt;pattern&gt;</span>
            <span class="nt">&lt;regexp&gt;</span>click_cost<span class="nt">&lt;/regexp&gt;</span>
            <span class="nt">&lt;function&gt;</span>any<span class="nt">&lt;/function&gt;</span>
            <span class="nt">&lt;retention&gt;</span>
                <span class="nt">&lt;age&gt;</span>0<span class="nt">&lt;/age&gt;</span>
                <span class="nt">&lt;precision&gt;</span>3600<span class="nt">&lt;/precision&gt;</span>
            <span class="nt">&lt;/retention&gt;</span>
            <span class="nt">&lt;retention&gt;</span>
                <span class="nt">&lt;age&gt;</span>86400<span class="nt">&lt;/age&gt;</span>
                <span class="nt">&lt;precision&gt;</span>60<span class="nt">&lt;/precision&gt;</span>
            <span class="nt">&lt;/retention&gt;</span>
        <span class="nt">&lt;/pattern&gt;</span>
        <span class="nt">&lt;default&gt;</span>
            <span class="nt">&lt;function&gt;</span>max<span class="nt">&lt;/function&gt;</span>
            <span class="nt">&lt;retention&gt;</span>
                <span class="nt">&lt;age&gt;</span>0<span class="nt">&lt;/age&gt;</span>
                <span class="nt">&lt;precision&gt;</span>60<span class="nt">&lt;/precision&gt;</span>
            <span class="nt">&lt;/retention&gt;</span>
            <span class="nt">&lt;retention&gt;</span>
                <span class="nt">&lt;age&gt;</span>3600<span class="nt">&lt;/age&gt;</span>
                <span class="nt">&lt;precision&gt;</span>300<span class="nt">&lt;/precision&gt;</span>
            <span class="nt">&lt;/retention&gt;</span>
            <span class="nt">&lt;retention&gt;</span>
                <span class="nt">&lt;age&gt;</span>86400<span class="nt">&lt;/age&gt;</span>
                <span class="nt">&lt;precision&gt;</span>3600<span class="nt">&lt;/precision&gt;</span>
            <span class="nt">&lt;/retention&gt;</span>
        <span class="nt">&lt;/default&gt;</span>
    <span class="nt">&lt;/graphite_rollup_example&gt;</span>
<span class="nt">&lt;/yandex&gt;</span>
</code></pre></div></div>

<h4 id="nclude_fromxml-設定">nclude_from.xml 設定</h4>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;yandex&gt;</span>
    <span class="nt">&lt;clickhouse_remote_servers&gt;</span>
        <span class="nt">&lt;ontime_cluster&gt;</span>
            <span class="nt">&lt;shard&gt;</span>
                <span class="nt">&lt;replica&gt;</span>
                    <span class="nt">&lt;default_database&gt;</span>r0<span class="nt">&lt;/default_database&gt;</span>
                    <span class="nt">&lt;host&gt;</span>ch-server-1<span class="nt">&lt;/host&gt;</span>
                    <span class="nt">&lt;port&gt;</span>9000<span class="nt">&lt;/port&gt;</span>
                <span class="nt">&lt;/replica&gt;</span>
                <span class="nt">&lt;replica&gt;</span>
                    <span class="nt">&lt;default_database&gt;</span>r1<span class="nt">&lt;/default_database&gt;</span>
                    <span class="nt">&lt;host&gt;</span>ch-server-3<span class="nt">&lt;/host&gt;</span>
                    <span class="nt">&lt;port&gt;</span>9000<span class="nt">&lt;/port&gt;</span>
                <span class="nt">&lt;/replica&gt;</span>
            <span class="nt">&lt;/shard&gt;</span>
            <span class="nt">&lt;shard&gt;</span>
                <span class="nt">&lt;replica&gt;</span>
                    <span class="nt">&lt;default_database&gt;</span>r0<span class="nt">&lt;/default_database&gt;</span>
                    <span class="nt">&lt;host&gt;</span>ch-server-2<span class="nt">&lt;/host&gt;</span>
                    <span class="nt">&lt;port&gt;</span>9000<span class="nt">&lt;/port&gt;</span>
                <span class="nt">&lt;/replica&gt;</span>
                <span class="nt">&lt;replica&gt;</span>
                    <span class="nt">&lt;default_database&gt;</span>r1<span class="nt">&lt;/default_database&gt;</span>
                    <span class="nt">&lt;host&gt;</span>ch-server-1<span class="nt">&lt;/host&gt;</span>
                    <span class="nt">&lt;port&gt;</span>9000<span class="nt">&lt;/port&gt;</span>
                <span class="nt">&lt;/replica&gt;</span>
            <span class="nt">&lt;/shard&gt;</span>
            <span class="nt">&lt;shard&gt;</span>
                <span class="nt">&lt;replica&gt;</span>
                    <span class="nt">&lt;default_database&gt;</span>r0<span class="nt">&lt;/default_database&gt;</span>
                    <span class="nt">&lt;host&gt;</span>ch-server-3<span class="nt">&lt;/host&gt;</span>
                    <span class="nt">&lt;port&gt;</span>9000<span class="nt">&lt;/port&gt;</span>
                <span class="nt">&lt;/replica&gt;</span>
                <span class="nt">&lt;replica&gt;</span>
                    <span class="nt">&lt;default_database&gt;</span>r1<span class="nt">&lt;/default_database&gt;</span>
                    <span class="nt">&lt;host&gt;</span>ch-server-2<span class="nt">&lt;/host&gt;</span>
                    <span class="nt">&lt;port&gt;</span>9000<span class="nt">&lt;/port&gt;</span>
                <span class="nt">&lt;/replica&gt;</span>
            <span class="nt">&lt;/shard&gt;</span>
        <span class="nt">&lt;/ontime_cluster&gt;</span>
    <span class="nt">&lt;/clickhouse_remote_servers&gt;</span>
    <span class="nt">&lt;zookeeper&gt;</span>
        <span class="nt">&lt;node&gt;</span>
            <span class="nt">&lt;host&gt;</span>zookeeper<span class="nt">&lt;/host&gt;</span>
            <span class="nt">&lt;port&gt;</span>2181<span class="nt">&lt;/port&gt;</span>
        <span class="nt">&lt;/node&gt;</span>
    <span class="nt">&lt;/zookeeper&gt;</span>
<span class="nt">&lt;networks&gt;</span>
   <span class="nt">&lt;ip&gt;</span>::/0<span class="nt">&lt;/ip&gt;</span>
<span class="nt">&lt;/networks&gt;</span>
    <span class="nt">&lt;clickhouse_compression&gt;</span>
    <span class="c">&lt;!--
        &lt;!- - Set of variants. Checked in order. Last matching case wins. If nothing matches, lz4 will be used. - -&gt;
        &lt;case&gt;

            &lt;!- - Conditions. All must be satisfied. Some conditions may be omitted. - -&gt;
            &lt;min_part_size&gt;10000000000&lt;/min_part_size&gt;        &lt;!- - Min part size in bytes. - -&gt;
            &lt;min_part_size_ratio&gt;0.01&lt;/min_part_size_ratio&gt;   &lt;!- - Min size of part relative to whole table size. - -&gt;

            &lt;!- - What compression method to use. - -&gt;
            &lt;method&gt;zstd&lt;/method&gt;
        &lt;/case&gt;
    --&gt;</span>
<span class="nt">&lt;/clickhouse_compression&gt;</span>
<span class="nt">&lt;/yandex&gt;</span>

</code></pre></div></div>

<h4 id="etchosts-設定">/etc/hosts 設定</h4>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>127.0.0.1 localhost
::1	localhost ip6-localhost ip6-loopback
fe00::0	ip6-localnet
ff00::0	ip6-mcastprefix
ff02::1	ip6-allnodes
ff02::2	ip6-allrouters
172.18.0.5 clickhouse-replication-example-master_ch-client_1
172.18.0.2 clickhouse-replication-example-master_ch-server-1_1 ch-server-1
172.18.0.6 clickhouse-replication-example-master_ch-server-2_1 ch-server-2
172.18.0.4 clickhouse-replication-example-master_ch-server-3_1 ch-server-3

</code></pre></div></div>

<h4 id="建立-database-r0-與-r1">建立 database r0 與 r1</h4>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>create database r0
create database r1
</code></pre></div></div>

<h4 id="在每一台-clickhouse-server-的-r0-database-建立-ontime_local-的-table">在每一台 clickhouse server 的 r0 database 建立 ontime_local 的 table</h4>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>CREATE TABLE ontime_local (FlightDate Date,Year UInt16) ENGINE = MergeTree(FlightDate, (Year, FlightDate), 8192)
</code></pre></div></div>

<h4 id="在每一台-clickhouse-server-的-r0-database-建立-ontime_all-的-distributed-table">在每一台 clickhouse server 的 r0 database 建立 ontime_all 的 Distributed table</h4>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>CREATE TABLE ontime_all AS ontime_local ENGINE = Distributed(ontime_cluster, r0, ontime_local, rand())
</code></pre></div></div>
<h4 id="新增資料做測試">新增資料做測試</h4>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>insert into ontime_local (FlightDate,Year)values('2001-11-11',2002)
insert into ontime_all (FlightDate,Year)values('2001-10-10',2001)
</code></pre></div></div>

<h4 id="執行結果">執行結果</h4>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>3cc9fa1f21de :) select * from ontime_all

SELECT *
FROM ontime_all

┌─FlightDate─┬─Year─┐
│ 2001-10-12 │ 2001 │
└────────────┴──────┘
┌─FlightDate─┬─Year─┐
│ 2001-11-12 │ 2002 │
└────────────┴──────┘

2 rows in set. Elapsed: 0.008 sec.

</code></pre></div></div>

<h4 id="mac-不支援-ln-tmpdatatxt-datalinktxt">mac 不支援 ln tmp/data.txt datalink.txt</h4>
<ul>
  <li>所以當 docker compose 的 volumes 有設定 - ./data/1:/var/lib/clickhouse 時，然後下 insert data 到 Distributed table 時會出現下列錯誤訊息 :</li>
</ul>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>2018.07.27 07:23:03.980974 [ 24 ] &lt;Debug&gt; executeQuery: (from 172.18.0.5:45980, query_id: 812384f4-79c8-4643-8fc7-8603f87eb628) insert into ontime_all (FlightDate,Year)values
2018.07.27 07:23:04.035044 [ 24 ] &lt;Error&gt; executeQuery: Code: 0, e.displayText() = DB::Exception: Could not link /var/lib/clickhouse/data/r0/ontime_all/default@ch%2Dserver%2D2:9000#r0/1.bin to /var/lib/clickhouse/data/r0/ontime_all/default@ch%2Dserver%2D2:9000#r0/tmp/1.bin, errno: 95, strerror: Operation not supported, e.what() = DB::Exception (from 172.18.0.5:45980) (in query: insert into ontime_all (FlightDate,Year)values), Stack trace:

</code></pre></div></div>

<h4 id="可查-systemclusters-看-clusters-的設定">可查 system.clusters 看 clusters 的設定</h4>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>804fab967898 :) select * from system.clusters

SELECT *
FROM system.clusters

┌─cluster────────┬─shard_num─┬─shard_weight─┬─replica_num─┬─host_name───┬─host_address─┬─port─┬─is_local─┬─user────┬─default_database─┐
│ ontime_cluster │         1 │            1 │           1 │ ch-server-1 │ 172.18.0.2   │ 9000 │        0 │ default │ r0               │
│ ontime_cluster │         1 │            1 │           2 │ ch-server-3 │ 172.18.0.4   │ 9000 │        0 │ default │ r1               │
│ ontime_cluster │         2 │            1 │           1 │ ch-server-2 │ 172.18.0.6   │ 9000 │        0 │ default │ r0               │
│ ontime_cluster │         2 │            1 │           2 │ ch-server-1 │ 172.18.0.2   │ 9000 │        0 │ default │ r1               │
│ ontime_cluster │         3 │            1 │           1 │ ch-server-3 │ 172.18.0.4   │ 9000 │        0 │ default │ r0               │
│ ontime_cluster │         3 │            1 │           2 │ ch-server-2 │ 172.18.0.6   │ 9000 │        0 │ default │ r1               │
└────────────────┴───────────┴──────────────┴─────────────┴─────────────┴──────────────┴──────┴──────────┴─────────┴──────────────────┘

6 rows in set. Elapsed: 0.003 sec.
</code></pre></div></div>

<h4 id="clickhouse-server-的-log-會記錄在">clickhouse server 的 log 會記錄在</h4>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/var/log/clickhouse-server/clickhouse-server.log
/var/log/clickhouse-server/clickhouse-server.err.log
</code></pre></div></div>

<h4 id="當-container-沒裝-ifconfig-時可先用-hostname--i-查-ip">當 container 沒裝 ifconfig 時可先用 hostname -I 查 IP</h4>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@42db1eabc7d6:/# hostname -I
172.18.0.5
</code></pre></div></div>

<h4 id="docker-compose-的一些指令">docker-compose 的一些指令</h4>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker-compose up

docker-compose ps

docker-compose logs

docker-compose rm

docker-compose down
</code></pre></div></div>

<blockquote>
  <p>參考資料<br />
<a href="http://clickhouse-docs.readthedocs.io/en/latest/table_engines/distributed.html">table_engines_distributed</a><br />
<a href="https://github.com/sonych/clickhouse-cluster">github 設定參考-1</a><br />
<a href="https://github.com/abraithwaite/clickhouse-replication-example">github 設定參考-2</a><br />
<a href="https://www.jianshu.com/p/ae45e0aa2b52">clickhouse cluster 參考</a></p>
</blockquote>


  </div>

  

  <a class="u-url" href="/clickhouse/2018/07/27/clickhouse_day5.html" hidden></a>
</article>

      </div>
    </main>

    <footer class="site-footer">

  <div class="wrapper">

    <h2 class="footer-heading">Daniel&#39;s Blog</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li>
            
              Daniel&#39;s Blog
            
            </li>
            
            <li><a href="mailto:your-email@example.com">your-email@example.com</a></li>
            
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/jekyll"><span class="icon icon--github"><svg viewBox="0 0 16 16" width="16px" height="16px"><path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/></svg>
</span><span class="username">jekyll</span></a>

          </li>
          

          
          <li>
            <a href="https://twitter.com/jekyllrb"><span class="icon icon--twitter"><svg viewBox="0 0 16 16" width="16px" height="16px"><path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/></svg>
</span><span class="username">jekyllrb</span></a>

          </li>
          
        </ul>
      </div>

      <div class="footer-col footer-col-3">
        <p>Write an awesome description for your new site here. You can edit this line in _config.yml. It will appear in your document head meta (for Google search results) and in your feed.xml site description.</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
